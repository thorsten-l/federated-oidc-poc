global
    log stdout  format raw  local0
    daemon
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    option  forwardfor  except 127.0.0.0/8

# HTTP: Redirect auf HTTPS
frontend fe_http
    bind *:80
    http-request redirect scheme https code 301 if !{ ssl_fc }

    # health endpoint (optional einfach)
    use_backend be_nc if { path_beg /status.php }

    default_backend be_nc

# HTTPS: TLS-Termination
frontend fe_https
    bind *:443 ssl crt /etc/haproxy/certs/server.pem
    # Wenn du Client-Zertifikatspflicht willst, auskommentieren:
    # verify optional oder required
    # ca-file /etc/haproxy/certs/ca.crt

    # SNI-basiert möglich, hier Single-Domain
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header Referrer-Policy "no-referrer"
    http-response set-header X-XSS-Protection "1; mode=block"

    # Wichtig für Nextcloud hinter Proxy:
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]

    default_backend be_nc

backend be_nc
    mode http
    option httpchk GET /status.php
    http-check expect string "\"installed\":true"
    server nextcloud fop-service-nextcloud:80 check
